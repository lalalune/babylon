// Trajectory Logging Schema for RLAIF Training
// Add this to your main schema.prisma file

model Trajectory {
  id              String   @id @default(cuid())
  trajectoryId    String   @unique
  agentId         String
  
  // Timing
  startTime       DateTime
  endTime         DateTime
  durationMs      Int
  
  // Grouping for GRPO training
  episodeId       String?  @index
  scenarioId      String?  @index
  batchId         String?  @index
  
  // JSON data (complete trajectory)
  stepsJson       String   @db.Text // JSON array of TrajectoryStep[]
  rewardComponentsJson String @db.Text
  metricsJson     String   @db.Text
  metadataJson    String   @db.Text
  
  // Quick access fields (denormalized for queries)
  totalReward     Float
  episodeLength   Int
  finalStatus     String   // 'completed' | 'terminated' | 'error' | 'timeout'
  finalBalance    Float?
  finalPnL        Float?
  tradesExecuted  Int?
  postsCreated    Int?
  
  // AI Judge rewards (populated later during training prep)
  aiJudgeReward   Float?
  aiJudgeReasoning String? @db.Text
  judgedAt        DateTime?
  
  // Training pipeline tracking
  isTrainingData  Boolean  @default(true)
  isEvaluation    Boolean  @default(false)
  usedInTraining  Boolean  @default(false)
  trainedInBatch  String?  @index
  
  // Relations
  agent           User     @relation("AgentTrajectories", fields: [agentId], references: [id])
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([agentId, startTime])
  @@index([scenarioId, createdAt])
  @@index([isTrainingData, usedInTraining])
  @@index([aiJudgeReward])
  @@map("trajectories")
}

model LLMCallLog {
  id              String   @id @default(cuid())
  trajectoryId    String
  stepId          String
  callId          String   @unique
  
  // Timing
  timestamp       DateTime
  latencyMs       Int?
  
  // Model
  model           String
  purpose         String   // 'action' | 'reasoning' | 'evaluation' | 'response'
  actionType      String?
  
  // Prompts (full context)
  systemPrompt    String   @db.Text
  userPrompt      String   @db.Text
  messagesJson    String?  @db.Text // Full conversation history
  
  // Response
  response        String   @db.Text
  reasoning       String?  @db.Text
  
  // Parameters
  temperature     Float
  maxTokens       Int
  topP            Float?
  
  // Usage
  promptTokens    Int?
  completionTokens Int?
  totalTokens     Int?
  
  // Metadata
  metadata        String?  @db.Text
  
  createdAt       DateTime @default(now())
  
  @@index([trajectoryId])
  @@index([callId])
  @@index([timestamp])
  @@map("llm_call_logs")
}

model TrainingBatch {
  id              String   @id @default(cuid())
  batchId         String   @unique
  scenarioId      String?
  
  // Model info
  baseModel       String
  modelVersion    String
  
  // Trajectories in this batch
  trajectoryIds   String   @db.Text // JSON array
  
  // GRPO training metadata
  rankingsJson    String?  @db.Text // Relative rankings
  rewardsJson     String   @db.Text // Normalized rewards
  
  // Training results
  trainingLoss    Float?
  policyImprovement Float?
  
  // Status
  status          String   // 'pending' | 'training' | 'completed' | 'failed'
  error           String?  @db.Text
  
  // Timing
  createdAt       DateTime @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  
  @@index([scenarioId])
  @@index([status, createdAt])
  @@map("training_batches")
}

model RewardJudgment {
  id              String   @id @default(cuid())
  trajectoryId    String   @unique
  
  // Judge info
  judgeModel      String
  judgeVersion    String
  
  // Scores
  overallScore    Float    // 0-1
  componentScoresJson String? @db.Text
  
  // Ranking (for RULER)
  rank            Int?
  normalizedScore Float?
  groupId         String?  @index
  
  // Explanation
  reasoning       String   @db.Text
  strengthsJson   String?  @db.Text
  weaknessesJson  String?  @db.Text
  
  // Criteria evaluated
  criteriaJson    String   @db.Text
  
  // Metadata
  judgedAt        DateTime @default(now())
  
  @@index([overallScore])
  @@index([groupId, rank])
  @@map("reward_judgments")
}

// Add this relation to your existing User model:
// trajectories    Trajectory[] @relation("AgentTrajectories")

