name: CI - Test All

on:
  pull_request:
    branches: [production, staging]
  push:
    branches: [production, staging]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_ENV: test
  CI: true

# Maximum performance with Blacksmith runners:
# Runners:
# - Build: blacksmith-8vcpu-ubuntu-2404 (fastest compilation, type checking, linting)
# - Unit/Integration: blacksmith-2vcpu-ubuntu-2404 (optimized for test execution)
# - E2E & Synpress: blacksmith-8vcpu-ubuntu-2404 (Playwright benefits from high CPU)
# - All jobs: 2x faster bare metal gaming CPUs with highest single-core performance
# Cache (automatic optimizations):
# - 4x faster cache downloads (colocated in same datacenter)
# - Existing actions/cache@v4 automatically accelerated (node_modules, .next)
# - Docker pull cache for postgres:16 service images (automatic)
# - 25GB free cache storage per repo/week (2.5x GitHub's 10GB limit)
# 
# Artifact strategy:
# - All jobs run in parallel - no artifact dependencies
# - Each job builds its own environment to maximize speed

jobs:
  # Build, typecheck, and lint job
  build-and-check:
    name: Build, Type Check & Lint
    runs-on: blacksmith-8vcpu-ubuntu-2404
    timeout-minutes: 20
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
      DIRECT_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
          # Increase PostgreSQL limits for large migrations with 76 tables
          POSTGRES_INITDB_ARGS: "--encoding=UTF8"
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --shm-size=1gb
        ports:
          - 5432:5432
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install
      
      - name: Setup environment variables
        env:
          # Use CI test database for build
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          DIRECT_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          # Pass secrets with correct names (not _VAR suffix)
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'test-secret-key' }}
          PRIVY_APP_ID: ${{ secrets.PRIVY_APP_ID || '' }}
          PRIVY_APP_SECRET: ${{ secrets.PRIVY_APP_SECRET || '' }}
          NEXT_PUBLIC_PRIVY_APP_ID: ${{ secrets.PRIVY_APP_ID || '' }}
          PRIVY_TEST_EMAIL: ${{ secrets.PRIVY_TEST_EMAIL || '' }}
          PRIVY_TEST_PHONE: ${{ secrets.PRIVY_TEST_PHONE || '' }}
          PRIVY_TEST_OTP: ${{ secrets.PRIVY_TEST_OTP || '' }}
          PRIVY_TEST_PASSWORD: ${{ secrets.PRIVY_TEST_PASSWORD || '' }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY || '' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || '' }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY || '' }}
          FAL_KEY: ${{ secrets.FAL_KEY || '' }}
          CRON_SECRET: ${{ secrets.CRON_SECRET || 'test-cron-secret' }}
          WALLET_SEED_PHRASE: ${{ secrets.WALLET_SEED_PHRASE || '' }}
          WALLET_PASSWORD: ${{ secrets.WALLET_PASSWORD || '' }}
        run: bash scripts/ci/prepare-env.sh
      
      - name: Setup Prisma and Database
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        run: |
          # Generate Prisma client first
          echo "üîß Generating Prisma client..."
          bunx prisma generate 2>&1 | sed -E 's/(Datasource|ep-soft-wildflower|neondb|@[^[:space:]]*\.neon\.tech)/[REDACTED]/g'
          
          # Force reset and apply migrations
          echo "üóÑÔ∏è Resetting database and applying migrations..."
          bunx prisma migrate reset --force --skip-generate 2>&1 | sed -E 's/(Datasource|ep-soft-wildflower|neondb|@[^[:space:]]*\.neon\.tech)/[REDACTED]/g'
          
          # Run seed to ensure test data is loaded
          echo "üå± Seeding database..."
          bunx prisma db seed 2>&1 | sed -E 's/(Datasource|ep-soft-wildflower|neondb|@[^[:space:]]*\.neon\.tech)/[REDACTED]/g'
          
          echo "‚úÖ Database setup complete"

      - name: Clean stale .next types before typecheck
        run: rm -rf .next/types
      
      - name: Type Check
        run: bun run typecheck
      
      - name: Lint
        run: bun run lint
      
      - name: Build Production
        env:
          NODE_OPTIONS: '--max-old-space-size=8192'
          SKIP_ENV_VALIDATION: true
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        run: |
          echo "üèóÔ∏è Building production..."
          bun run build 2>&1 | sed -E 's/(Datasource|ep-soft-wildflower|neondb|@[^[:space:]]*\.neon\.tech)/[REDACTED]/g'
          echo "‚úÖ Build complete"
      
      - name: Verify build artifacts exist
        run: |
          if [ -d .next ]; then
            echo "‚úÖ Build completed successfully"
            du -sh .next
          else
            echo "‚ùå Build failed - .next directory does not exist"
            exit 1
          fi
