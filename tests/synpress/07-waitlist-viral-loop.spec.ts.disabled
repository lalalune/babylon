/**
 * Synpress E2E Test: Waitlist Viral Loop - Complete Flow
 * 
 * Tests the complete viral loop including:
 * - User A signs up, gets invite code
 * - User B signs up with User A's code
 * - User A gets +50 points
 * - User A's rank improves
 * - Leaderboard updates correctly
 */

import { testWithSynpress } from '@synthetixio/synpress'
import { MetaMask, metaMaskFixtures } from '@synthetixio/synpress/playwright'
import { expect } from '@playwright/test'

const test = testWithSynpress(metaMaskFixtures({}))

const { describe } = test

const BASE_URL = process.env.BASE_URL || 'http://localhost:3000'
const WAITLIST_URL = `${BASE_URL}/?comingsoon=true`

describe('Waitlist Viral Loop - Complete E2E Flow', () => {
  let user1InviteCode: string
  let user1Email: string
  let user1InitialRank: number
  let user1UserId: string

  test.skip('FULL VIRAL LOOP: User A signup â†’ User B uses referral â†’ User A moves up', async ({ 
    context, 
    page,
    metamask 
  }: any) => {
    console.log('ðŸ§ª Starting complete viral loop E2E test...')

    // ============================================================
    // PART 1: User A Signs Up (Without Referral)
    // ============================================================
    console.log('ðŸ“ Part 1: User A signs up for waitlist')

    await page.goto(WAITLIST_URL)
    await page.click('text=Join Waitlist')

    // Wait for Privy modal
    await page.waitForSelector('[data-privy-modal]', { timeout: 15000 })

    // Use email login for easier testing
    const emailOption = page.locator('button:has-text("Email")').first()
    if (await emailOption.isVisible().catch(() => false)) {
      await emailOption.click()

      // Enter test email
      user1Email = `test-user-${Date.now()}@example.com`
      await page.fill('input[type="email"]', user1Email)
      await page.click('button:has-text("Continue")')

      // Enter OTP (you would need to retrieve this from email in real test)
      // For now, this will fail without real OTP
      console.log('â© Skipping OTP verification (requires email access)')
      test.skip()
      return
    }

    // ============================================================
    // PART 2: Complete Onboarding
    // ============================================================
    console.log('ðŸ“ Part 2: Complete onboarding flow')

    // Wait for onboarding modal
    await page.waitForTimeout(3000)

    // Fill in profile if onboarding modal appears
    const usernameField = page.locator('input[name="username"]')
    if (await usernameField.isVisible().catch(() => false)) {
      await usernameField.fill(`testuser${Date.now()}`)
      
      const displayNameField = page.locator('input[placeholder*="display name" i]')
      await displayNameField.fill('Test User A')

      // Submit profile
      await page.click('button:has-text("Continue"), button:has-text("Submit")')
      await page.waitForTimeout(2000)
    }

    // ============================================================
    // PART 3: Get Waitlist Position and Invite Code
    // ============================================================
    console.log('ðŸ“ Part 3: Check initial position and get invite code')

    await page.waitForTimeout(3000)

    // Should be on waitlist page now
    await expect(page.locator('text=/Your Position in Line/i')).toBeVisible({ timeout: 10000 })

    // Extract position
    const positionText = await page.locator('text=/#\\d+/').first().textContent()
    const positionMatch = positionText?.match(/#(\\d+)/)
    if (positionMatch) {
      user1InitialRank = parseInt(positionMatch[1])
      console.log(`âœ… User A initial rank: #${user1InitialRank}`)
    }

    // Extract invite code
    const inviteCodeElement = await page.locator('text=/\\?ref=\\w+/').textContent()
    const codeMatch = inviteCodeElement?.match(/\\?ref=(\\w+)/)
    if (codeMatch) {
      user1InviteCode = codeMatch[1]
      console.log(`âœ… User A invite code: ${user1InviteCode}`)
    }

    expect(user1InviteCode).toBeTruthy()

    // ============================================================
    // PART 4: User B Signs Up With Referral
    // ============================================================
    console.log('ðŸ“ Part 4: User B signs up with User A\\'s referral code')

    // Open new incognito context for User B
    const user2Context = await context.browser().newContext()
    const user2Page = await user2Context.newPage()

    // Visit with referral code
    await user2Page.goto(`${WAITLIST_URL}&ref=${user1InviteCode}`)
    await user2Page.click('text=Join Waitlist')

    // Complete signup for User B (simplified)
    await user2Page.waitForTimeout(5000)
    console.log('âœ… User B signup initiated')

    // Close User B context
    await user2Context.close()

    // ============================================================
    // PART 5: Verify User A Got Points and Rank Improved
    // ============================================================
    console.log('ðŸ“ Part 5: Verify User A got +50 points and rank improved')

    // Refresh User A's page
    await page.reload()
    await page.waitForTimeout(3000)

    // Check for +50 invite points
    const invitePointsText = await page.locator('text=/Invite Points/').locator('..').textContent()
    expect(invitePointsText).toContain('50')

    // Check if rank improved or stayed same (depending on other users)
    const newRankText = await page.locator('text=/#\\d+/').first().textContent()
    const newRankMatch = newRankText?.match(/#(\\d+)/)
    if (newRankMatch) {
      const newRank = parseInt(newRankMatch[1])
      console.log(`âœ… User A new rank: #${newRank} (was #${user1InitialRank})`)
      
      // Rank should be same or better (lower number)
      expect(newRank).toBeLessThanOrEqual(user1InitialRank)
    }

    // Check for "You've invited X people" message
    await expect(page.locator('text=/invited 1 person/i')).toBeVisible()

    console.log('âœ… Viral loop test completed successfully!')
  })
})

describe('Waitlist to Launch Flow', () => {
  test.skip('should graduate user from waitlist', async ({ request }) => {
    // This tests the graduation API (admin function)
    // Would need admin auth in real test

    console.log('ðŸŽ“ Testing waitlist graduation')

    // Note: This endpoint might not exist yet or require admin auth
    const response = await request.post(`${BASE_URL}/api/waitlist/graduate`, {
      data: {
        userId: 'test-user-id',
      },
      headers: {
        'Content-Type': 'application/json',
      },
    })

    // Endpoint might not be implemented yet
    console.log('Graduate API status:', response.status())
  })
})

